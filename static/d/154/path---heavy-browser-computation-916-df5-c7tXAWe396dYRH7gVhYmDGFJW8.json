{"data":{"site":{"siteMetadata":{"title":"Canastro's notes","author":"Ricardo Canastro"}},"markdownRemark":{"id":"e412d619-ae28-57e6-82e4-11c8b269db87","excerpt":"At  dashdash  we build spreadsheets with super-powers, we aim to create tools that make computation accessible to everyone. Our spreadsheet supports the…","html":"<p>At <a href=\"https://www.dashdash.com\">dashdash</a> we build spreadsheets with super-powers, we aim to create tools that make computation accessible to everyone.</p>\n<p>Our spreadsheet supports the standard excel formulas, external API integration formulas and some dashdash formulas that allow you to integrate any API through GET and POST requests. Given this flexibility most of our computation has to be done in the backend, but not all of it. For the formulas that do not require HTTP requests to be fired, we could “easily” do them in the frontend.</p>\n<p>Currently we do all the computation on the backend, that means that even the “trival” operations such as arithemetical operations need to go the backend, and these are operations should feel immediate to the user. Nobody got time to wait ~80ms for a <strong>sum</strong> result <img class=\"emoji-icon\" data-icon=\"emoji-smile\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, 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\">.</p>\n<h1>Optimistic Updates</h1>\n<p>This quarter we want to be able to have double engine computation, the frontend should optimistically do computation and still requests to our backend engine to do computation and persist the computed values. The frontend computation would have some limitations as it would only do computation on cells that do not require or dependen on external HTTP requests.</p>\n<p>While most users have simple spreadsheets, we only limit the graph of dependencies of a cell to 100 000. A power user can easily create a spreadsheet with a insane cell dependencies graph. So, given our large constraints, editing a cell might have a ripple effect that triggers operations in thousands of other cells either directly or by association with other cells. If we execute those operations by iterating each affected cell / formula we’ll completely freeze the browser and provide a terrible user experience.</p>\n<h1>Requirements</h1>\n<p>Our solution for the frontend computation should support the following requirements:</p>\n<ul>\n<li>No dropped frames, the page should be responsive at all times</li>\n<li>Processing should be interruptable (either because new data was introduced or user wants to leave the page)</li>\n<li>UI should be updated only when full computation is complete (we don’t want stale data to be presented)</li>\n<li>Should be as fast as possible given the previous constraints (if we split execution in chunks it will take a bit longer to process but the page will be responsive, and therefore the perceived perfomance will appear to be better)</li>\n<li>Relatively easy to maintain and to reason with</li>\n</ul>\n<h1>How to test our solutions</h1>\n<ul>\n<li>Create a simple example;</li>\n<li>Use <a href=\"https://github.com/sw-yx/async-render-toolbox\">async-render-toolbox</a> chrome extensions to have a visual cue of the CPU lag;</li>\n<li>Create a counter and a timer to make sure page is still interactive while processing a queue;</li>\n<li>Use devtools for some extra performance inspection;</li>\n</ul>\n<h1>Test case</h1>\n<p>A spreadsheet in which A1=99 and each row from A2 to A100000 adds 10 the previous row. A2 will be computed to 109, A3 to 119, etc. A100000 will be 99 + (10 * 99 999) = 1 000 089. As you can imagine, changing the value of A1 will have a ripple effect and 99 999 calcs would have to be done, <strong>sequentially</strong>. </p>\n<p>We need to define a datastructure and a traversal algorithm to test our solutions. Since the problem we’re tackling is only related with high CPU usage, we can easily create this scenario without a complex algorithm or data strucuture. Lets not think about possible circular dependencies, cells with multiple dependencies, ranges to select cells and other challenges that we already face on the backend computation.</p>\n<p>Given a object with each cell indexed by id, we’re going to start computation by the cell A1 and then get the next child until we find a cell without child.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">A1</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">'A1'</span><span class=\"token punctuation\">,</span>\n    child<span class=\"token punctuation\">:</span> <span class=\"token string\">'A2'</span><span class=\"token punctuation\">,</span>\n    formula<span class=\"token punctuation\">:</span> <span class=\"token number\">99</span><span class=\"token punctuation\">,</span>\n    value<span class=\"token punctuation\">:</span> <span class=\"token number\">99</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">A2</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">'A2'</span><span class=\"token punctuation\">,</span>\n    child<span class=\"token punctuation\">:</span> <span class=\"token string\">'A3'</span><span class=\"token punctuation\">,</span>\n    formula<span class=\"token punctuation\">:</span> <span class=\"token string\">'=A1+10'</span><span class=\"token punctuation\">,</span>\n    value<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token constant\">A2000000</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token string\">'A2000000'</span><span class=\"token punctuation\">,</span>\n    child<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    formula<span class=\"token punctuation\">:</span> <span class=\"token string\">'=A1999999+10'</span><span class=\"token punctuation\">,</span>\n    value<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In each iteration we’re going to update the value of the cell and then move to the next one.</p>\n<h1>Approach</h1>\n<p>There are a few possible aproaches that we’ll want to explore and each will have their own trade-offs:</p>\n<ul>\n<li>Schedule cpu idle periods to compute calculations</li>\n<li>Webworkers</li>\n<li>Generators (?)</li>\n<li>Process only the cells within the viewport, and rely on the BE response for the rest</li>\n</ul>\n<p>In this blog post I’ll explore one in particular, the usage of cpu idle periods to perform our CPU intensive work, inspired by react’s fiber architecture, and in particular react’s scheduler package. </p>\n<blockquote>\n<p>The <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback\">window.requestIdleCallback()</a> method queues a function to be called during a browser’s idle periods. This enables developers to perform background and low priority work on the main event loop, without impacting latency-critical events such as animation and input response. Functions are generally called in first-in-first-out order; however, callbacks which have a timeout specified may be called out-of-order if necessary in order to run them before the timeout elapses.</p>\n</blockquote>\n<p>By calling requestIdleCallback we schedule a callback for the next idle period. In that callback we can check how long we got left before the idle period ends by calling <code class=\"language-text\">deadline.timeRemaining()</code>. The maximium amount of idle time is 50ms, but most of the times we’ll get less time than that depending on how busy the CPU is. Using the timeRemaining and a constant max time for each calculation we can check if we have free time to do one more calc or reschedule to the next idle period. We’ll schedule a new callback until there are no more tasks to execute. By processing our cells this way, we make sure to not interrupt latency-critical events and provide a smooth user experience. </p>\n<p>If we’re processing 100 calcs, the time to execution with idle does not vary much from the regular blocking operation, but if we’re processing 2 000 000, the idle approach will take longer, but smoother. Its a tradeoff, that personally, I think its worth it. </p>\n<p>There is though, a caveat, the <a href=\"https://caniuse.com/#search=requestIdle\">browser support</a> is not yet ideal… Its not yet supported by neither IE Edge or safari… Always those two, right? <img class=\"emoji-icon\" data-icon=\"emoji-disappointed\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, 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\"> There are ways to shim it, such as this simple <a href=\"https://gist.github.com/paullewis/55efe5d6f05434a96c36\">gist</a> and <a href=\"https://github.com/facebook/react/blob/master/packages/scheduler/src/Scheduler.js#L415\">react’s approach</a>, which is a more complex and robust.</p>\n<h1>Lets code!</h1>\n<p>This is our dummy computation function (It’s pretty much hardcoded and does not reflect the real world code). This function extracts the id of the cell in the formula, adds 10 to the value of the referred cell, updates the current cell value and returns the next cell: </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> formula <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> nextUnitOfWork<span class=\"token punctuation\">.</span>task<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> isFormula <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>formula <span class=\"token operator\">+</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isFormula<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> parentId <span class=\"token operator\">=</span> formula<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\">/A\\d*/</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// hardcoded stuff</span>\n        <span class=\"token keyword\">const</span> previousValue <span class=\"token operator\">=</span> spreadsheet<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>parentId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> newValue <span class=\"token operator\">=</span> previousValue <span class=\"token operator\">+</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n        spreadsheet<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>nextUnitOfWork<span class=\"token punctuation\">.</span>task<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> newValue<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextUnitOfWork<span class=\"token punctuation\">.</span>task<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/** \n     * Keeping the triggerId will allow us to know at all times \n     * which cell triggered the current computation\n     */</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> \n      triggerId<span class=\"token punctuation\">:</span> nextUnitOfWork<span class=\"token punctuation\">.</span>triggerId<span class=\"token punctuation\">,</span> \n      task<span class=\"token punctuation\">:</span> spreadsheet<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>nextUnitOfWork<span class=\"token punctuation\">.</span>task<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">]</span> \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>How we would we do this with a regular <code class=\"language-text\">while</code> loop:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> task <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> trigger<span class=\"token punctuation\">:</span> task<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> task <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>With a requestIdleCallback scheduler:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/**\n * How long we think that we need to have to be able \n * to process a single unit of work\n * We might need to tweak this.\n */</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">ENOUGH_TIME</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// in ms</span>\n<span class=\"token keyword\">let</span> workQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">resetNextUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> task <span class=\"token operator\">=</span> workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>task<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n  nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> triggerId<span class=\"token punctuation\">:</span> task<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> task <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextUnitOfWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">resetNextUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">&amp;&amp;</span> deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token constant\">ENOUGH_TIME</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">performWork</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">||</span> workQueue<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>performWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">function</span> <span class=\"token function\">scheduleWork</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/** \n   * Verify if there is already a work being \n   * process that was triggered by the same cell\n   */</span>\n  <span class=\"token keyword\">const</span> isInProgress <span class=\"token operator\">=</span> \n    nextUnitOfWork <span class=\"token operator\">&amp;&amp;</span> \n    nextUnitOfWork<span class=\"token punctuation\">.</span>triggerId <span class=\"token operator\">===</span> task<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInProgress<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>performWork<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A task represents a cell that has been changed and we need to check if this change will effect other cells and recompute their values.</p>\n<p>Given a task we check if there is already a work in progress that was triggered by this cell, if so that should be interrupted and added back to the end of the workQueue. After updating the queue, a performWork is scheduled with the <strong>requestIdleCallback</strong>.</p>\n<p>When we get a slot of idle time, the function <strong>performWork</strong> is called, this function calls the <strong>workLoop</strong> which is responsible to get the next task in the workQueue and then do a while loop to <strong>performUnitOfWork</strong> while we still have idle time left. The <strong>performUnitOfWork</strong> does the formula computation and returns the child of the current cell, that child is assinged to the <strong>nextUnitOfWork</strong>. Once theres no more time to process more cells, the performWork function will schedule a <strong>requestIdleCallback</strong> to pickup the work on the next cpu idle time.</p>\n<p>This loop will keep going on until there are no more nextUnitOfWork or items in the workQueue.</p>\n<h1>Results</h1>\n<p>The blocking iteration approach is much faster to execute, but, as visible in <strong>fig. 1</strong> it has a lot of drop frames. The page would be unresponsive for a second there. The idle callback approach takes longer to execute, its time of execution is not predictable as it depends on how busy the CPU is, but the page is responsive at all times (<strong>fig. 2</strong>) and therefore the perceived performance might be much better.</p>\n<div class=\"gallery\">\n  <div class=\"gallery__item\">\n    <img src=\"/regular-radar-only-e38b913c481a88a368c2d2506b584554.gif\">\n    <label><strong>fig. 1:</strong> with while loop</label>\n  </div>\n  <div class=\"gallery__item\">\n    <img src=\"/idle-radar-only-302b9a609f2bf8289228abbb0fe1145b.gif\">\n    <label><strong>fig. 2:</strong> with idle callback</label>\n  </div>\n</div>\n<h1>Conclusion</h1>\n<p>In this isolated test it seems that the approach with <strong>requestIdleCallback</strong> checks our requirements.</p>\n<p>But, there are a few topics that will require further exploration:</p>\n<ul>\n<li>How well does this work integrated with react’s scheduler?</li>\n<li>According to <a href=\"https://twitter.com/sebmarkbage/status/822881464794497024\">@sebmarkbage</a> most requestIdleCallback shims are not a accurate representation of what requestIdleCallback should do. Can we find a good shim or even use the one that react uses?</li>\n<li>Can we limit our FE computations to cells that are in the viewport (or close by) and at the same time provide a good UX?</li>\n</ul>\n<p>You can check this <a href=\"https://github.com/canastro/heavy-fe-computation\">github repo</a> with all the approaches that we’ll try out before a final decision is taken.</p>\n<p><em><strong>Disclaimer:</strong> Opinions are my own and not the views of my employer.</em></p>\n<p><em>If you find any error, be it on my poor english or any technical detail, please don’t be shy. I’ll try to continuously improve this blog post <img class=\"emoji-icon\" data-icon=\"emoji-simple_smile\" style=\"display: inline; margin: 0; margin-top: 1px; position: relative; top: 5px; width: 25px\" src=\"data:image/png;base64, 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\"></em></p>","frontmatter":{"title":"A spike about heavy browser computation","subtitle":"Schedule work with requestIdleCallback","date":"January 11, 2019"}}},"pageContext":{"tags":[{"text":"javascript","link":"/tags/javascript/"},{"text":"dashdash","link":"/tags/dashdash/"},{"text":"spike","link":"/tags/spike/"}],"slug":"/2019-01-11---heavy-browser-computation/","previous":{"fields":{"slug":"/2019-01-09---ts-extend-modify/"},"frontmatter":{"title":"Typescript - Extending and modifying existing types with Mapped Types","path":"/ts-mapped-types","tags":["react","typescript"]}},"next":null}}